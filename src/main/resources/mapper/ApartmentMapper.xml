<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jipjung.project.repository.ApartmentMapper">

    <!-- Result Map -->
    <resultMap id="ApartmentTransactionResultMap" type="com.jipjung.project.domain.ApartmentTransaction">
        <id property="id" column="id"/>
        <result property="apartmentName" column="apartment_name"/>
        <result property="legalDong" column="legal_dong"/>
        <result property="roadAddress" column="road_address"/>
        <result property="buildYear" column="build_year"/>
        <result property="dealAmount" column="deal_amount"/>
        <result property="dealDate" column="deal_date"/>
        <result property="exclusiveArea" column="exclusive_area"/>
        <result property="floor" column="floor"/>
        <result property="createdAt" column="created_at"/>
    </resultMap>

    <!-- 동적 검색 조건 -->
    <sql id="searchConditions">
        <where>
            <if test="request.legalDong != null and request.legalDong != ''">
                AND legal_dong LIKE CONCAT('%', #{request.legalDong}, '%')
            </if>
            <if test="request.apartmentName != null and request.apartmentName != ''">
                AND apartment_name LIKE CONCAT('%', #{request.apartmentName}, '%')
            </if>
            <if test="request.dealDateFrom != null and request.dealDateFrom != ''">
                AND deal_date &gt;= #{request.dealDateFrom}
            </if>
            <if test="request.dealDateTo != null and request.dealDateTo != ''">
                AND deal_date &lt;= #{request.dealDateTo}
            </if>
            <if test="request.minDealAmount != null">
                AND deal_amount &gt;= #{request.minDealAmount}
            </if>
            <if test="request.maxDealAmount != null">
                AND deal_amount &lt;= #{request.maxDealAmount}
            </if>
        </where>
    </sql>

    <!-- 아파트 실거래가 목록 조회 (검색 및 페이징) -->
    <select id="findAll" resultMap="ApartmentTransactionResultMap">
        SELECT id, apartment_name, legal_dong, road_address, build_year,
               deal_amount, deal_date, exclusive_area, floor, created_at
        FROM apartment_transaction
        <include refid="searchConditions"/>
        ORDER BY deal_date DESC, id DESC
        LIMIT #{request.size} OFFSET #{request.page}
    </select>

    <!-- 아파트 실거래가 상세 조회 -->
    <select id="findById" resultMap="ApartmentTransactionResultMap">
        SELECT id, apartment_name, legal_dong, road_address, build_year,
               deal_amount, deal_date, exclusive_area, floor, created_at
        FROM apartment_transaction
        WHERE id = #{id}
    </select>

    <!-- 전체 개수 조회 (페이징용) -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM apartment_transaction
        <include refid="searchConditions"/>
    </select>

</mapper>
