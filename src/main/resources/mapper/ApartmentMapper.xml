<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jipjung.project.repository.ApartmentMapper">

    <!-- Result Map - Apartment -->
    <resultMap id="ApartmentResultMap" type="com.jipjung.project.domain.Apartment">
        <id property="aptSeq" column="apt_seq"/>
        <result property="dongCode" column="dong_code"/>
        <result property="sggCd" column="sgg_cd"/>
        <result property="umdCd" column="umd_cd"/>
        <result property="umdNm" column="umd_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNmSggCd" column="road_nm_sgg_cd"/>
        <result property="roadNm" column="road_nm"/>
        <result property="roadNmBonbun" column="road_nm_bonbun"/>
        <result property="roadNmBubun" column="road_nm_bubun"/>
        <result property="aptNm" column="apt_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="createdAt" column="apt_created_at"/>
        <result property="updatedAt" column="apt_updated_at"/>
    </resultMap>

    <!-- Result Map - ApartmentDeal -->
    <resultMap id="ApartmentDealResultMap" type="com.jipjung.project.domain.ApartmentDeal">
        <id property="dealNo" column="deal_no"/>
        <result property="aptSeq" column="apt_seq"/>
        <result property="aptDong" column="apt_dong"/>
        <result property="floor" column="floor"/>
        <result property="dealYear" column="deal_year"/>
        <result property="dealMonth" column="deal_month"/>
        <result property="dealDay" column="deal_day"/>
        <result property="dealDate" column="deal_date"/>
        <result property="excluUseAr" column="exclu_use_ar"/>
        <result property="dealAmount" column="deal_amount"/>
        <result property="dealAmountNum" column="deal_amount_num"/>
        <result property="createdAt" column="deal_created_at"/>
    </resultMap>

    <!-- Result Map - Apartment + Latest Deal (목록용) -->
    <resultMap id="ApartmentWithLatestDealMap" type="com.jipjung.project.domain.Apartment">
        <id property="aptSeq" column="apt_seq"/>
        <result property="aptNm" column="apt_nm"/>
        <result property="umdNm" column="umd_nm"/>
        <result property="roadNm" column="road_nm"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="createdAt" column="apt_created_at"/>
        <result property="updatedAt" column="apt_updated_at"/>
        <association property="latestDeal" javaType="com.jipjung.project.domain.ApartmentDeal">
            <id property="dealNo" column="deal_no"/>
            <result property="dealDate" column="deal_date"/>
            <result property="dealAmountNum" column="deal_amount_num"/>
            <result property="excluUseAr" column="exclu_use_ar"/>
            <result property="floor" column="floor"/>
        </association>
    </resultMap>

    <!-- Result Map - Apartment + All Deals (상세용) -->
    <resultMap id="ApartmentWithAllDealsMap" type="com.jipjung.project.domain.Apartment">
        <id property="aptSeq" column="apt_seq"/>
        <result property="aptNm" column="apt_nm"/>
        <result property="umdNm" column="umd_nm"/>
        <result property="jibun" column="jibun"/>
        <result property="roadNm" column="road_nm"/>
        <result property="roadNmBonbun" column="road_nm_bonbun"/>
        <result property="roadNmBubun" column="road_nm_bubun"/>
        <result property="buildYear" column="build_year"/>
        <result property="latitude" column="latitude"/>
        <result property="longitude" column="longitude"/>
        <result property="createdAt" column="apt_created_at"/>
        <result property="updatedAt" column="apt_updated_at"/>
        <collection property="deals" ofType="com.jipjung.project.domain.ApartmentDeal">
            <id property="dealNo" column="deal_no"/>
            <result property="aptDong" column="apt_dong"/>
            <result property="floor" column="floor"/>
            <result property="dealDate" column="deal_date"/>
            <result property="dealAmountNum" column="deal_amount_num"/>
            <result property="excluUseAr" column="exclu_use_ar"/>
            <result property="dealYear" column="deal_year"/>
            <result property="dealMonth" column="deal_month"/>
            <result property="dealDay" column="deal_day"/>
            <result property="dealAmount" column="deal_amount"/>
        </collection>
    </resultMap>

    <!-- 아파트 검색 조건 (apartment 테이블) -->
    <sql id="apartmentConditions">
        <where>
            <if test="request.aptNm != null and request.aptNm != ''">
                AND a.apt_nm LIKE CONCAT('%', #{request.aptNm}, '%')
            </if>
            <if test="request.umdNm != null and request.umdNm != ''">
                AND a.umd_nm LIKE CONCAT('%', #{request.umdNm}, '%')
            </if>
        </where>
    </sql>

    <!-- 거래 검색 조건 (apartment_deal 테이블) -->
    <sql id="dealConditions">
        <where>
            <if test="request.dealDateFrom != null and request.dealDateFrom != ''">
                AND deal_date &gt;= #{request.dealDateFrom}
            </if>
            <if test="request.dealDateTo != null and request.dealDateTo != ''">
                AND deal_date &lt;= #{request.dealDateTo}
            </if>
            <if test="request.minDealAmount != null">
                AND deal_amount_num &gt;= #{request.minDealAmount}
            </if>
            <if test="request.maxDealAmount != null">
                AND deal_amount_num &lt;= #{request.maxDealAmount}
            </if>
        </where>
    </sql>

    <!-- 아파트 목록 조회 (최신 실거래 1건씩 포함) -->
    <select id="findAllWithLatestDeal" resultMap="ApartmentWithLatestDealMap">
        SELECT
        a.apt_seq,
        a.apt_nm,
        a.umd_nm,
        a.road_nm,
        a.build_year,
        a.latitude,
        a.longitude,
        a.created_at as apt_created_at,
        a.updated_at as apt_updated_at,
        d.deal_no,
        d.deal_date,
        d.deal_amount_num,
        d.exclu_use_ar,
        d.floor
        FROM apartment a

        -- [핵심 변경] LEFT JOIN LATERAL 사용
        LEFT JOIN LATERAL (
        SELECT
        deal_no,
        deal_date,
        deal_amount_num,
        exclu_use_ar,
        floor
        FROM apartment_deal ad
        WHERE ad.apt_seq = a.apt_seq  -- 바깥쪽 테이블(a)의 키를 참조 (For Loop 처럼 동작)

        <include refid="dealConditions"/>

        -- 인덱스를 태워서 가장 최신 1건만 빠르게 조회
        ORDER BY deal_date DESC, deal_no DESC
        LIMIT 1
        ) d ON TRUE -- LATERAL은 조건이 안쪽에 있으므로 ON TRUE로 연결

        -- 아파트 검색 조건 (이름, 동 등)
        <include refid="apartmentConditions"/>

        -- 정렬 (MySQL 호환: NULLS LAST 대신 IS NULL ASC 사용)
        ORDER BY
        (d.deal_date IS NULL) ASC,
        d.deal_date DESC,
        a.apt_nm
        LIMIT #{request.size} OFFSET #{request.offset}
    </select>

    <!-- 아파트 상세 조회 (모든 실거래 이력 포함) -->
    <select id="findByAptSeqWithDeals" resultMap="ApartmentWithAllDealsMap">
        SELECT
        a.apt_seq,
        a.apt_nm,
        a.umd_nm,
        a.jibun,
        a.road_nm,
        a.road_nm_bonbun,
        a.road_nm_bubun,
        a.build_year,
        a.latitude,
        a.longitude,
        a.created_at as apt_created_at,
        a.updated_at as apt_updated_at,
        d.deal_no,
        d.apt_dong,
        d.floor,
        d.deal_date,
        d.deal_amount_num,
        d.exclu_use_ar,
        d.deal_year,
        d.deal_month,
        d.deal_day,
        d.deal_amount
        FROM apartment a
        LEFT JOIN apartment_deal d
        ON a.apt_seq = d.apt_seq
        -- [추가] 1. 검색 조건이 있다면 ON 절에 추가 (예: 최근 3년, 30평대만 보기 등)
        -- LEFT JOIN 성질을 유지하기 위해 WHERE가 아닌 ON에 붙임
        <if test="request != null">
            <include refid="dealConditions"/>
        </if>
        WHERE a.apt_seq = #{aptSeq}
        ORDER BY d.deal_date DESC, d.deal_no DESC

        -- [추가] 2. 데이터 폭증 방지용 안전장치 (최근 300건만)
        LIMIT 300
    </select>

    <!-- 아파트 기본정보만 조회 -->
    <select id="findByAptSeq" resultMap="ApartmentResultMap">
        SELECT
            apt_seq,
            dong_code,
            sgg_cd,
            umd_cd,
            umd_nm,
            jibun,
            road_nm_sgg_cd,
            road_nm,
            road_nm_bonbun,
            road_nm_bubun,
            apt_nm,
            build_year,
            latitude,
            longitude,
            created_at as apt_created_at,
            updated_at as apt_updated_at
        FROM apartment
        WHERE apt_seq = #{aptSeq}
    </select>

    <!-- apt_seq 존재 여부 확인 -->
    <select id="existsByAptSeq" resultType="boolean">
        SELECT COUNT(*) > 0
        FROM apartment
        WHERE apt_seq = #{aptSeq}
    </select>

    <!-- 전체 개수 조회 (페이징용) -->
    <select id="count" resultType="int">
        SELECT COUNT(*)
        FROM apartment a
        <where>
            <include refid="apartmentConditions"/>

            <if test="request.minDealAmount != null or request.maxDealAmount != null or request.dealDateFrom != null or request.dealDateTo != null">
                AND EXISTS (
                SELECT 1
                FROM apartment_deal d
                WHERE d.apt_seq = a.apt_seq
                <include refid="dealConditions"/>
                )
            </if>
        </where>
    </select>

</mapper>
