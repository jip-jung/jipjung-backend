<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.jipjung.project.repository.DreamHomeMapper">

    <!-- Result Map (with Apartment) -->
    <resultMap id="DreamHomeResultMap" type="com.jipjung.project.domain.DreamHome">
        <id property="dreamHomeId" column="dream_home_id"/>
        <result property="userId" column="user_id"/>
        <result property="aptSeq" column="apt_seq"/>
        <result property="targetAmount" column="target_amount"/>
        <result property="targetDate" column="target_date"/>
        <result property="monthlyGoal" column="monthly_goal"/>
        <result property="currentSavedAmount" column="current_saved_amount"/>
        <result property="startDate" column="start_date"/>
        <result property="status" column="status" typeHandler="org.apache.ibatis.type.EnumTypeHandler"/>
        <result property="createdAt" column="created_at"/>
        <result property="updatedAt" column="updated_at"/>
        <result property="isDeleted" column="is_deleted"/>
        <!-- 아파트 정보 조인 -->
        <association property="apartment" javaType="com.jipjung.project.domain.Apartment">
            <id property="aptSeq" column="apt_seq"/>
            <result property="aptNm" column="apt_nm"/>
            <result property="umdNm" column="umd_nm"/>
            <result property="roadNm" column="road_nm"/>
            <result property="buildYear" column="build_year"/>
            <result property="latitude" column="latitude"/>
            <result property="longitude" column="longitude"/>
        </association>
    </resultMap>

    <!-- 사용자의 활성 드림홈 조회 (with 아파트) -->
    <select id="findActiveByUserId" resultMap="DreamHomeResultMap">
        SELECT dh.*, a.apt_nm, a.umd_nm, a.road_nm, a.build_year, a.latitude, a.longitude
        FROM dream_home dh
        LEFT JOIN apartment a ON dh.apt_seq = a.apt_seq
        WHERE dh.user_id = #{userId}
          AND dh.status = 'ACTIVE'
          AND dh.is_deleted = false
        LIMIT 1
    </select>

    <!-- 드림홈 단건 조회 (with 아파트) -->
    <select id="findById" resultMap="DreamHomeResultMap">
        SELECT dh.*, a.apt_nm, a.umd_nm, a.road_nm, a.build_year, a.latitude, a.longitude
        FROM dream_home dh
        LEFT JOIN apartment a ON dh.apt_seq = a.apt_seq
        WHERE dh.dream_home_id = #{dreamHomeId}
          AND dh.is_deleted = false
        LIMIT 1
    </select>

    <!-- 드림홈 생성 -->
    <insert id="insert" parameterType="com.jipjung.project.domain.DreamHome"
            useGeneratedKeys="true" keyProperty="dreamHomeId" keyColumn="dream_home_id">
        INSERT INTO dream_home (user_id, apt_seq, target_amount, target_date, monthly_goal, current_saved_amount, start_date, status)
        VALUES (#{userId}, #{aptSeq}, #{targetAmount}, #{targetDate}, #{monthlyGoal}, #{currentSavedAmount}, #{startDate}, #{status})
    </insert>

    <!-- 드림홈 목표 업데이트 (저축액 유지) -->
    <update id="updateDreamHome" parameterType="com.jipjung.project.domain.DreamHome">
        UPDATE dream_home
        SET apt_seq = #{aptSeq},
            target_amount = #{targetAmount},
            target_date = #{targetDate},
            monthly_goal = #{monthlyGoal},
            start_date = #{startDate},
            status = 'ACTIVE',
            updated_at = CURRENT_TIMESTAMP
        WHERE dream_home_id = #{dreamHomeId}
          AND is_deleted = false
    </update>

    <!-- 드림홈 상태 업데이트 -->
    <update id="updateStatus">
        UPDATE dream_home
        SET status = #{status},
            updated_at = CURRENT_TIMESTAMP
        WHERE dream_home_id = #{dreamHomeId}
          AND is_deleted = false
    </update>

    <!-- 현재 저축액 업데이트 -->
    <update id="updateCurrentSavedAmount">
        UPDATE dream_home
        SET current_saved_amount = #{currentSavedAmount},
            updated_at = CURRENT_TIMESTAMP
        WHERE dream_home_id = #{dreamHomeId}
          AND is_deleted = false
    </update>

</mapper>
